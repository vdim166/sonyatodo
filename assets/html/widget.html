<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Widget</title>

    <style>
      body {
        margin: 0;
        padding: 0;
        background: rgba(0, 0, 0, 0);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
        user-select: none;
        cursor: default;
      }

      .widget-container {
        background: rgba(40, 40, 40, 0.9);
        border-radius: 12px;
        color: white;
        padding: 15px;
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        height: calc(100% - 32px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transition: all 0.2s ease;
      }

      .widget-container.dragging {
        background: rgba(50, 50, 50, 0.95);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        border-color: rgba(255, 255, 255, 0.25);
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: grab;
      }

      .header:active {
        cursor: grabbing;
      }

      .header-title {
        font-size: 14px;
        font-weight: 600;
        opacity: 0.9;
      }

      .controls {
        display: flex;
        gap: 6px;
      }

      .control-btn {
        background: rgba(255, 255, 255, 0.08);
        border: none;
        border-radius: 4px;
        width: 22px;
        height: 22px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.15s ease;
        opacity: 0.7;
      }

      .control-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        opacity: 1;
        transform: scale(1.1);
      }

      .control-btn.close:hover {
        background: rgba(255, 80, 80, 0.3);
      }

      .content {
        padding: 5px 0;
      }

      /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
        100% {
          transform: scale(1);
        }
      }

      .dragging .widget-container {
        animation: pulse 0.5s ease-in-out;
      }

      #important_dates {
        display: flex;
        flex-direction: column;
        gap: 5px;

        max-height: 100px;
        overflow: hidden auto;
      }

      #important_dates::-webkit-scrollbar {
        width: 6px; /* Vertical scrollbar width */
        height: 8px;
      }

      #important_dates::-webkit-scrollbar-track {
        background: transparent; /* Track color */
        border-radius: 5px;
      }

      #important_dates::-webkit-scrollbar-thumb {
        background: rgb(69, 69, 99); /* Thumb color */
        border-radius: 5px;
      }

      #important_dates::-webkit-scrollbar-thumb:hover {
        background: rgb(88, 88, 228); /* Hover effect */
        cursor: grab;
      }

      .birthday {
        padding: 8px;
        color: white;
        background-color: rgb(104, 104, 226);
        border-radius: 5px;
        margin-bottom: 5px;
      }

      .birthday.soon {
        background-color: orange;
      }

      .birthday.today {
        background-color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="widget-container">
      <div class="header" id="widget-header">
        <div class="header-title">üìã SONYA TODO</div>
        <div class="controls">
          <button class="control-btn refresh" onclick="loadImportantDates()">
            <svg
              width="20px"
              height="20px"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
              <g
                id="SVGRepo_tracerCarrier"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></g>
              <g id="SVGRepo_iconCarrier">
                <path
                  d="M4.06189 13C4.02104 12.6724 4 12.3387 4 12C4 7.58172 7.58172 4 12 4C14.5006 4 16.7332 5.14727 18.2002 6.94416M19.9381 11C19.979 11.3276 20 11.6613 20 12C20 16.4183 16.4183 20 12 20C9.61061 20 7.46589 18.9525 6 17.2916M9 17H6V17.2916M18.2002 4V6.94416M18.2002 6.94416V6.99993L15.2002 7M6 20V17.2916"
                  stroke="white"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                ></path>
              </g>
            </svg>
          </button>
        </div>
      </div>

      <div class="content">
        <div id="important_dates"></div>
      </div>
    </div>
  </body>
</html>

<script>
  class WidgetDragger {
    constructor() {
      this.isDragging = false;
      this.init();
    }

    init() {
      this.setupEventListeners();
    }

    setupEventListeners() {
      const header = document.getElementById('widget-header');
      const body = document.body;

      if (!header) return;

      // –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
      header.addEventListener('mousedown', (e) => {
        this.startDrag(e);
      });

      // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
      document.addEventListener('mousemove', (e) => {
        this.drag(e);
      });

      // –ö–æ–Ω–µ—Ü –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
      document.addEventListener('mouseup', (e) => {
        this.endDrag(e);
      });

      // –î–ª—è touch —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      header.addEventListener('touchstart', (e) => {
        this.startDrag(e.touches[0]);
      });

      document.addEventListener('touchmove', (e) => {
        if (e.touches.length > 0) {
          this.drag(e.touches[0]);
          e.preventDefault();
        }
      });

      document.addEventListener('touchend', (e) => {
        this.endDrag(e);
      });

      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
      header.addEventListener('selectstart', (e) => {
        if (this.isDragging) {
          e.preventDefault();
        }
      });

      // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
      header.addEventListener('dblclick', () => {
        this.toggleMinimize();
      });
    }

    startDrag(event) {
      this.isDragging = true;

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –º—ã—à–∏
      this.startX = event.clientX;
      this.startY = event.clientY;

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –≥–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
      if (window.electron.ipcRenderer) {
        window.electron.ipcRenderer.startDrag(event.screenX, event.screenY);
      }

      // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
      document.body.classList.add('dragging');
      event.preventDefault();
    }

    drag(event) {
      if (!this.isDragging) return;

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏ –≤ –≥–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
      if (window.electron.ipcRenderer) {
        window.electron.ipcRenderer.dragWindow(event.screenX, event.screenY);
      }

      event.preventDefault();
    }

    endDrag(event) {
      if (this.isDragging) {
        this.isDragging = false;

        // –£–≤–µ–¥–æ–º–ª—è–µ–º –≥–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        if (window.electron.ipcRenderer) {
          window.electron.ipcRenderer.endDrag(event.screenX, event.screenY);
        }

        document.body.classList.remove('dragging');
      }
    }

    toggleMinimize() {
      if (window.electron.ipcRenderer) {
        window.electron.ipcRenderer.minimizeWidget();
      }
    }
  }

  // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–∫–Ω–æ–º
  function closeWidget() {
    if (window.electron.ipcRenderer) {
      window.electron.ipcRenderer.closeWidget();
    }
  }

  function minimizeWidget() {
    if (window.electron.ipcRenderer) {
      window.electron.ipcRenderer.minimizeWidget();
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  document.addEventListener('DOMContentLoaded', function () {
    new WidgetDragger();

    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    const closeBtn = document.querySelector('.control-btn.close');
    const minBtn = document.querySelector('.control-btn.minimize');

    if (closeBtn) {
      closeBtn.addEventListener('click', closeWidget);
    }

    if (minBtn) {
      minBtn.addEventListener('click', minimizeWidget);
    }

    console.log('Widget loaded with fixed drag functionality');
  });
</script>

<script>
  function getUpcomingBirthdays(list) {
    const MS_DAY = 24 * 60 * 60 * 1000;
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // midnight —Å–µ–≥–æ–¥–Ω—è

    return list
      .map((item) => {
        const [mm, dd] = item.date.split('-').map(Number);
        // —Å–æ–±—Ä–∞—Ç—å –¥–∞—Ç—É –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ–¥–∞
        let next = new Date(today.getFullYear(), mm - 1, dd);

        // –ï—Å–ª–∏ birthday —É–∂–µ –ø—Ä–æ—à—ë–ª –≤ —ç—Ç–æ–º –≥–æ–¥—É (–º–µ–Ω—å—à–µ —á–µ–º midnight —Å–µ–≥–æ–¥–Ω—è) ‚Äî –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥
        if (next < today) next.setFullYear(next.getFullYear() + 1);

        // diff –≤ –¥–Ω—è—Ö (0 = —Å–µ–≥–æ–¥–Ω—è)
        const diffDays = Math.round((next - today) / MS_DAY);

        return { ...item, next, diffDays };
      })
      .sort((a, b) => a.next - b.next);
  }

  function getMonthName(date) {
    const months = [
      'January',
      'February',
      'March',
      'April',
      'May',
      'June',
      'July',
      'August',
      'September',
      'October',
      'November',
      'December',
    ];

    const [monthIndex, dayIndex] = date.split('-');

    return `${months[Number(monthIndex) - 1]} ${dayIndex}`;
  }

  // –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è + –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  function renderUpcoming(birthdays) {
    const sorted = getUpcomingBirthdays(birthdays);
    const container = document.querySelector('#important_dates');
    if (!container) return;

    // –±–ª–∏–∂–∞–π—à–µ–µ
    const nearest = sorted[0];

    // —Ä–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫
    container.innerHTML = sorted
      .map((b) => {
        const cls =
          b.diffDays === 0
            ? 'today'
            : b.diffDays > 0 && b.diffDays <= 10
              ? 'soon'
              : '';
        return `<div class="birthday ${cls}" data-diff="${b.diffDays}">
        <strong>${b.name}</strong> ‚Äî <span>${getMonthName(b.date)}</span>
        <small> (${b.diffDays} ${pluralizeDays(b.diffDays)})</small>
      </div>`;
      })
      .join('');
  }

  // –ù–µ–±–æ–ª—å—à–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞ "–¥–µ–Ω—å"
  function pluralizeDays(n) {
    if (n === 0) return '—Å–µ–≥–æ–¥–Ω—è';
    n = Math.abs(n) % 100;
    if (n > 10 && n < 20) return '–¥–Ω–µ–π';
    const rem = n % 10;
    if (rem === 1) return '–¥–µ–Ω—å';
    if (rem >= 2 && rem <= 4) return '–¥–Ω—è';
    return '–¥–Ω–µ–π';
  }

  // –ó–∞–ø—É—Å–∫

  const loadImportantDates = async () => {
    const dates = await window.electron.ipcRenderer.getAllImportantDates();

    renderUpcoming(dates.dates);
  };

  loadImportantDates();
</script>

<script>
  window.electron.ipcRenderer.on('update-widget-todo-data', (event) => {
    loadImportantDates();
  });
</script>
